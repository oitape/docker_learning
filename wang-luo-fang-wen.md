## 网络访问
这章学习以下内容，关注于单主机网络
- 在Docker中如何将容器连接到网络
- 创建暴露在网络上运行的容器
- 一个容器使用另外一个容器的网络软件
- 容器时如何与主机还有主机网络进行交互的。

### Docker的网络
Docker关系两种类型网络：单主机虚拟网络和多主机虚拟网络。本地虚拟网络用来提供容器隔离。多主机虚拟网络构建了一个抽象的覆盖网络，在这个网络中，任何容器相对于网络上的其他容器都拥有独立的、可路由的IP地址。

#### 本地Docker网络拓扑结构
Docker使用操作系统的底层特性构建了一个特殊的、可定制的虚拟网络拓扑结构。这个虚拟网络只在安装有Docker的机器上有效，并且它由主机上的机器和主机所连接的网络之间的路由构成。
每个容器各自拥有一个本地回环接口和一个分离的以太网接口，其中以太网接口连接着在主机命名空间上的另一个虚拟接口。这两个互联的接口在主机网络栈和每个容器的网络栈之间建立了连接。每个容器都被赋予了一个唯一的私有IP地址，从外部的网络不能直接连接到该私有IP。网络连接需要经过Docker网桥接口路由到另一网络，这个网桥接口被称为`docker 0`，可以吧`docker 0`想象成路由器，为每个容器创建的虚拟接口都会连接到`docker 0`，这样他们就构成一个网络。最后这个网桥接口`docker 0`会连接到主机所连接的网络。
![](/assets/Snip20190404_1.png)

使用docker命令行工具，可以自定义IP地址、网桥接口docker 0所连接的主机接口、容器之间通信的方式。Docker使用内核命名空间来创建这些私有的虚拟接口，但是命名空间本身不提供网络的隔离。网络暴露或者隔离是通过煮鸡蛋防护墙规则来实现。

#### Docker命令行选项提供四种网络容器原型
所有的Docker容器都要符合这四种原型中的一种，原型定义了一个容器如何与其他的本地容器、主机网络进行通讯。每一种原型有不同的目的，你可以认为他们拥有不同程度的隔离。
- Closed容器
- Joined容器
- Bridged容器
- Open容器

下图最强大意味着隔离程度最高
![](/assets/Snip20190404_2.png)


- ##### Closed容器

这种容器不允许任何网络流量，运行这种容器只能访问本地回环接口。如果进程只需要和本省或者其他本地进程通信的话，采用这种容器。
所有Docker容器都有权限访问一个私有的本地回环接口，Docker为每一个容器创建私有本地回环接口，目的是让运行在容器中的程序能够通过网络进行通信，且这些通信不能离开容器。
通过添加`--net none`参数创建closed容器
```sh
//创建  并列出所有的接口
docker run --rm --net none alpine ip addr
```
可看到本地回环接口是唯一可用的网络接口，并且绑定在127.0.0.1上

我们还可以进行测试看Close容器是否能访问到外部网络，尝试访问谷歌DNS服务器
```sh
docker run --rm --net none alpine ping -w 2 8.8.8.8
```
可以发现输出结果`ping: sendto: Network unreachable`

- ##### Bridged容器
Bridged容器放开了网络的隔离程度，可定制性最高。Bridged容器拥有两个接口，一个是私有的本地回环接口，另一个是私有接口通过网桥连接到主机的其他容器。
Bridged容器时最常见的网络容器原型。

   - ###### 访问外部网络
   选择Bridged容器通常是进程需要访问外部网络，使用docker run命令中的 --net选项，可以忽略，或者将--net的值设置为bridge.
   ```
   docker run --rm --net bridge alpine ip addr
   ```
   尝试下访问外部网络`docker run --rm alpine ping -w 2 8.8.8.8`
   你会看到容器执行了2秒的ping测试并输出了相关ping的信息
   
   - ###### 自定义命名解析
   域名系统DNS是将主机名映射成IP地址的协议。网桥网络上的容器和其他在该网络上的计算机，拥有不具备公共路由能力的IP地址是非常典型的。除非你运行有自己的DNS服务器，否则你不能通过名字来映射他们。
   Docker提供了不同的选项来自定义DNS配置。
   docker run命令有一个`--hostname`选项，你可以使用这个选项来设置一个新容器的主机名。这个选项会在该容器的DNS覆盖系统中添加一条记录。这条记录会将提供的主机名映射成该容器的桥接IP地址。
   ```
   docker run --rm --hostname barker alpine nslookup barker
   ```
   最后一行的IP地址就是新创建的容器的桥接IP地址。
   
   








